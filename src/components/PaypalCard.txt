// src/components/PaypalCard.tsx
"use client";
import { useEffect, useRef } from "react";

interface PaypalCardProps {
  amount: number;
  currency?: "IDR" | "USD";
  onComplete: (payload: any) => void;
  onError?: (err: any) => void;
}

export default function PaypalCard({
  amount,
  currency = "IDR",
  onComplete,
  onError,
}: PaypalCardProps) {
  const paypalRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    const win = window as any;
    if (!paypalRef.current || !win.paypal) return;

    // === FORMAT KE USD ===
    const rate = 15500;
    const valueUSD = (amount / rate).toFixed(2);

    // Render tombol PayPal Yellow + Debit/Credit Card (Smart Button)
    const fundingSources = [
      win.paypal.FUNDING.PAYPAL, // ðŸŸ¨ PayPal Checkout
      win.paypal.FUNDING.CARD,   // â¬› Debit / Credit Card
    ];

    fundingSources.forEach((fundingSource) => {
      win.paypal.Buttons({
        fundingSource,
        style: {
          layout: "vertical",
          shape: "rect",
          height: 45,
          label: fundingSource === win.paypal.FUNDING.PAYPAL ? "paypal" : "pay",
          tagline: fundingSource === win.paypal.FUNDING.PAYPAL, // hanya PayPal yang pakai tagline
        },
        createOrder: async () => {
          const res = await fetch("/api/paypal/create-order", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ amount: valueUSD, currency: "USD" }),
          });
          const data = await res.json();
          return data.orderID;
        },
        onApprove: async (data: any) => {
          const res = await fetch("/api/paypal/capture-order", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ orderID: data.orderID }),
          });
          const result = await res.json();
          if (result?.data?.status === "COMPLETED") {
            onComplete({ orderID: data.orderID });
          } else {
            onError?.(new Error("Gagal capture"));
          }
        },
        onError: (err: any) => onError?.(err),
      }).render(paypalRef.current);
    });
  }, [amount, currency, onComplete, onError]);

  return (
    <div className="space-y-4 p-4 bg-white rounded-lg border">
      <div ref={paypalRef} className="space-y-2"></div>
    </div>
  );
}
